name: Auto Build ARM64 on Official Release

# 触发方式：官方 xmrig 仓库每打一个新 tag，就触发你的 ARM64 自托管 runner
on:
  release:
    types: [published]                  # 官方发布正式版时触发
  workflow_dispatch:                    # 手动调试用

jobs:
  build-arm64:
    runs-on: self-hosted                  # ← 必须这行！用你自己的 ARM64 服务器
    # 不需要 container，因为你已经在 ARM64 Ubuntu 本机环境里

    steps:
    - name: Clean workspace (self-hosted)
      run: |
        rm -rf ./*
        rm -rf ./.??*
        ls -la

    - name: Checkout official xmrig source
      uses: actions/checkout@v4
      with:
        repository: xmrig/xmrig
        ref: ${{ github.event.release.tag_name }}

    - name: Install dependencies (only once or cache)
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake libuv1-dev libssl-dev libhwloc-dev

    - name: Show version & CPU info
      run: |
        echo "Building XMRig ${{ github.event.release.tag_name }} on $(uname -m)"
        nproc

    - name: CMake & Make (ARM64 optimized)
      run: |
        mkdir -p build && cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DARM_TARGET=8 \
          -DWITH_HWLOC=ON \
          -DWITH_OPENCL=OFF \
          -DWITH_CUDA=OFF \
          -DWITH_TLS=ON
        make -j$(nproc)
        strip xmrig

    - name: Determine release tag
      id: tag
      run: |
        if [ "${{ github.event.release.tag_name }}" != "" ]; then
          echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          echo "Using official release tag: ${{ github.event.release.tag_name }}"
        else
          # 手动运行时自动使用官方最新 tag（超级稳）
          LATEST_TAG=$(curl -s https://api.github.com/repos/xmrig/xmrig/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Manual run → using official latest tag: $LATEST_TAG"
        fi

    - name: Package ARM64 binary
      run: |
        cd build
        tar -czf xmrig-${{ steps.tag.outputs.tag }}-linux-arm64.tar.gz xmrig
        sha256sum xmrig-${{ steps.tag.outputs.tag }}-linux-arm64.tar.gz > SHA256SUMS

    - name: Upload to release (手动/自动都完美工作)
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.tag }}                 # 关键！统一用这个
        name: ARM64 Build - ${{ steps.tag.outputs.tag }}
        body: |
          Automated ARM64 build for XMRig ${{ steps.tag.outputs.tag }}

          Built on real ARM64 self-hosted runner with crypto extensions enabled.
        files: |
          build/xmrig-${{ steps.tag.outputs.tag }}-linux-arm64.tar.gz
          build/SHA256SUMS
        overwrite_files: true
        fail_on_unmatched_files: true
        generate_release_notes: false
