name: Auto Build XMRig ARM64 (cron + manual)

# 每6小时检查一次官方最新 release（可改成 '0 3 * * *' 每天凌晨3点）
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:   # 手动触发

jobs:
  build-arm64:
    runs-on: self-hosted   # 你的 ARM64 自托管 runner
    steps:
      # 1. 防止 apt/dpkg 卡死（self-hosted 必备）
      - name: Fix apt/dpkg lock
        run: |
          sudo killall -9 apt apt-get dpkg || true
          sudo rm -f /var/lib/dpkg/lock* /var/cache/apt/archives/lock || true
          sudo dpkg --configure -a || true

      # 2. 清理工作区（self-hosted 必备）
      - name: Clean workspace
        run: |
          rm -rf ./* ./.??* || true

      # 3. 获取官方最新 tag
      - name: Get official latest tag
        id: latest
        run: |
          LATEST=$(curl -s https://api.github.com/repos/xmrig/xmrig/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
          echo "latest_tag=$LATEST" >> $GITHUB_OUTPUT
          echo "Official latest release: $LATEST"

      # 4. 检查你自己的仓库是否已经存在这个 tag 的 release（已构建过就跳过）
      - name: Check if already built
        id: check
        run: |
          if gh release view ${{ steps.latest.outputs.latest_tag }} --repo ${{ github.repository }} >/dev/null 2>&1; then
            echo "already_built=true" >> $GITHUB_OUTPUT
            echo "✓ ARM64 package already exists for ${{ steps.latest.outputs.latest_tag }}, skipping build."
          else
            echo "already_built=false" >> $GITHUB_OUTPUT
            echo "✗ No ARM64 package yet → will build ${{ steps.latest.outputs.latest_tag }}"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      # 5. 只有没构建过才执行下面所有步骤
      - name: Checkout + Build + Upload (only if new)
        if: steps.check.outputs.already_built == 'false'
        env:
          TAG: ${{ steps.latest.outputs.latest_tag }}     # ← 所有环境变量放一起
          GH_TOKEN: ${{ github.token }}                   # ← 合并，不要再单独写 env 了
        run: |
          echo "=== Starting build for $TAG ==="

          git clone --depth 1 --branch $TAG https://github.com/xmrig/xmrig.git .
          
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y build-essential cmake libuv1-dev libssl-dev libhwloc-dev

          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DARM_TARGET=8 -DWITH_HWLOC=ON -DWITH_OPENCL=OFF -DWITH_CUDA=OFF
          make -j$(nproc)
          strip xmrig

          tar -czf xmrig-${TAG}-linux-arm64.tar.gz xmrig
          sha256sum xmrig-${TAG}-linux-arm64.tar.gz > SHA256SUMS

          gh release create $TAG \
            xmrig-${TAG}-linux-arm64.tar.gz \
            SHA256SUMS \
            --title "ARM64 Build - $TAG" \
            --notes "Automated ARM64 build for official XMRig $TAG (real ARM64 hardware + crypto extensions)" \
            --repo ${{ github.repository }} \
            --clobber   # 允许覆盖已存在文件
